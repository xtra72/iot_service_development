= MQTT를 이용한 데이터 흐름 관리

**MQTT를 통한 IoT 데이터 전송**에서 **토픽 설계**와 **메시지 페이로드 구조화**는 IoT 시스템의 데이터가 **일관성** 있고 **효율적**으로 처리되도록 하는 중요한 요소입니다. 이 작업을 통해 **collector**에서 수집된 다양한 데이터를 통일된 방식으로 **data processing 모듈**에 전달할 수 있습니다. 아래는 MQTT 토픽 설계와 메시지 페이로드 구조화에 대한 자세한 설명입니다.

---

== 1. **MQTT 토픽 설계 및 메시지 구분**

MQTT에서 **토픽(topic)**은 데이터를 구독하는 모듈이 메시지의 성격과 출처를 구분하는 중요한 역할을 합니다. MQTT는 **퍼블리시/구독(pub/sub)** 모델을 사용하며, 특정 토픽을 통해 **서브스크라이버**가 관심 있는 데이터만 선택적으로 받을 수 있게 합니다. 따라서 토픽 구조를 **체계적**으로 설계하여 다양한 데이터를 분류하는 것이 중요합니다.

=== 1.1 **토픽 설계의 주요 요소**
토픽을 설계할 때는 **엔드포인트(endpoint)**, **위치(location)**, **사이트(site)** 등의 구분을 포함하여 데이터의 출처와 성격을 명확히 합니다. 각 요소는 계층적으로 설계되어 **토픽 필터링**과 **구독 관리**가 용이해집니다.

1. **사이트(Site)**: 데이터가 수집된 물리적 장소나 구역을 나타내며, 공장, 농장, 창고 등의 단위로 구분.
2. **위치(Location)**: 특정 사이트 내의 세부 위치를 나타내며, 라인 번호나 구역 번호 등의 단위로 분류.
3. **디바이스 타입(Device Type)**: 데이터가 수집된 센서나 디바이스의 종류를 나타내며, 온도 센서, 습도 센서 등의 디바이스 타입으로 설정.
4. **데이터 타입(Data Type)**: 수집된 데이터의 유형을 나타내며, 온도, 습도, 조도 등 측정한 데이터의 성격을 지정.

=== 1.2 **토픽 구조 예시**
* **형식**: **/<site>/<location>/<device_type>/<data_type>**
* **구조 설명**: 각 레벨이 계층 구조로 나뉘어 있어 **필터링**이 용이하며, 구독자가 특정 기준에 맞는 데이터를 구독할 수 있습니다.

**예시 토픽:**

* **/factory1/lineA/temp_sensor/temperature**: Factory1의 LineA에서 온도 센서로 수집된 온도 데이터를 의미.
* **/farm1/greenhouse1/humidity_sensor/humidity**: Farm1의 Greenhouse1에서 습도 센서로 수집된 습도 데이터.
* **/warehouseA/zone3/light_sensor/illuminance**: WarehouseA의 Zone3에서 조도 센서로 수집된 조도 데이터.

=== 1.3 **토픽 필터링 예시**
MQTT는 특정 위치나 특정 데이터 타입의 데이터를 구독할 수 있도록 **와일드카드**(**+**와 **#**)를 지원합니다.

* **\+/+/*_sensor/temperature**: 모든 사이트와 위치에서 수집된 모든 온도 데이터를 구독.
* **/factory1/#**: factory1 내 모든 데이터를 구독.
* **\+/greenhouse1/+/+**: 모든 농장의 Greenhouse1 내의 모든 센서 데이터를 구독.

== 2. **메시지 페이로드 구조화**

페이로드는 **메시지 본문**이며, 데이터를 **JSON 형식**과 같이 통일된 구조로 정의하여 **data processing 모듈**에서 쉽게 처리할 수 있도록 합니다. 데이터의 형식과 필드를 정형화하면 **데이터베이스 삽입** 또는 **실시간 분석** 단계에서 효율성이 높아집니다.

=== 2.1 **페이로드 설계의 주요 요소**

1. **sensor_id**: 센서의 고유 ID를 지정하여, 데이터를 발행한 디바이스를 식별할 수 있습니다.
2. **data_type**: 수집된 데이터의 유형을 정의하여, 데이터 분석 시 필요한 데이터 타입을 쉽게 구분할 수 있습니다.
3. **value**: 센서가 측정한 실제 데이터 값입니다.
4. **timestamp**: 데이터가 수집된 시간으로, 시간 기반 분석과 추세 파악에 필수적인 요소입니다.
5. **frequency**: 데이터 수집 주기나 수집 빈도를 표시하여, 데이터 처리와 저장 빈도 최적화에 도움이 됩니다.

=== 2.2 **정형화된 JSON 페이로드 예시**
* **예시 1**: 온도 센서 데이터
+
[source,json]
----
{
  "sensor_id": "temp001",
  "data_type": "temperature",
  "value": 23.5,
  "timestamp": "2024-10-22T10:00:00Z",
  "frequency": "5min"
}
----

* **예시 2**: 습도 센서 데이터
+
[source,json]
----
{
  "sensor_id": "hum001",
  "data_type": "humidity",
  "value": 60,
  "timestamp": "2024-10-22T10:00:00Z",
  "frequency": "1min"
}
----

=== 2.3 **메시지 페이로드 필드 설명**
* **sensor_id**: **"temp001"**은 온도 센서를 식별하며, 이를 통해 동일한 디바이스에서 발생한 데이터를 추적 가능.
* **data_type**: **"temperature"** 또는 **"humidity"**는 데이터의 종류를 나타내어, 분석 또는 시각화 시 쉽게 분류할 수 있습니다.
* **value**: 센서의 측정값으로, 수집된 정보를 기반으로 한 실시간 처리에 사용.
* **timestamp**: **"2024-10-22T10:00:00Z"**는 UTC 표준으로 시간 표시하여, 다양한 타임존의 데이터를 통합 분석.
* **frequency**: 데이터가 수집되는 빈도로, 데이터 관리 및 분석 주기 설정에 유용.

== 3. **정형화된 메시지 구조의 장점**

이러한 정형화된 메시지 구조를 사용하면 **collector**에서 수집된 데이터를 **일관된 방식으로 data processing 모듈**에 전달할 수 있으며, 여러 장점을 제공합니다.

* **일관성 유지**: 모든 메시지가 표준화된 구조로 정의되어 있어 데이터 흐름이 균일하며, 구독 모듈이 데이터를 쉽게 분석.
* **확장성**: 새로운 데이터 타입이 추가되거나 센서가 추가되어도 기존 토픽 구조와 페이로드 형식을 따라가기 때문에 별도의 설정 없이 통합.
* **간편한 필터링 및 구독**: 토픽 구조가 계층적이고 필터링 가능해 특정 데이터만 선택적으로 구독하여 네트워크 부하 최소화.


== 4. **정리**

* **토픽 설계**와 **메시지 페이로드 구조화**는 데이터가 **collector**에서 data processing 모듈로 원활히 전달되고, 처리, 분석, 모니터링까지 일관성 있게 진행될 수 있도록 합니다.

---

[cols="1a,1a,1a",grid=none,frame=none]
|===
<s|
^s|link:../../../README.md[목차]
>s|
|===